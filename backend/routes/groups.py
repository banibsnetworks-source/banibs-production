"""\nBANIBS Backend - Groups API Routes\nPhase 8.5 - Groups & Membership\n"""\n\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom motor.motor_asyncio import AsyncIOMotorDatabase\nfrom typing import List, Optional\n\nfrom ..dependencies import get_current_user, get_db\nfrom ..schemas.group import (\n    GroupCreate,\n    GroupUpdate,\n    GroupResponse,\n    GroupDetailResponse,\n    GroupMemberResponse,\n    JoinGroupRequest,\n    UpdateMemberRoleRequest\n)\nfrom ..db import groups as groups_db\n\nrouter = APIRouter(prefix="/api/groups", tags=["groups"])\n\n\n@router.post("", response_model=GroupResponse, status_code=status.HTTP_201_CREATED)\nasync def create_group(\n    group_data: GroupCreate,\n    current_user: dict = Depends(get_current_user),\n    db: AsyncIOMotorDatabase = Depends(get_db)\n):\n    """Create a new group"""\n    group = await groups_db.create_group(\n        db=db,\n        name=group_data.name,\n        description=group_data.description,\n        category=group_data.category,\n        is_private=group_data.is_private,\n        tags=group_data.tags or [],\n        creator_id=current_user["id"],\n        creator_name=f\"{current_user['first_name']} {current_user['last_name']}\"\n    )\n    return GroupResponse(**group)\n\n\n@router.get("", response_model=List[GroupResponse])\nasync def get_groups(\n    category: Optional[str] = None,\n    search: Optional[str] = None,\n    limit: int = 20,\n    offset: int = 0,\n    db: AsyncIOMotorDatabase = Depends(get_db)\n):\n    """Get all groups with optional filters"""\n    groups = await groups_db.get_groups(\n        db=db,\n        category=category,\n        search=search,\n        limit=limit,\n        offset=offset\n    )\n    return [GroupResponse(**group) for group in groups]\n\n\n@router.get("/my-groups", response_model=List[GroupResponse])\nasync def get_my_groups(\n    current_user: dict = Depends(get_current_user),\n    db: AsyncIOMotorDatabase = Depends(get_db)\n):\n    """Get all groups the current user is a member of"""\n    groups = await groups_db.get_user_groups(db=db, user_id=current_user["id"])\n    return [GroupResponse(**group) for group in groups]\n\n\n@router.get("/{group_id}", response_model=GroupDetailResponse)\nasync def get_group(\n    group_id: str,\n    current_user: dict = Depends(get_current_user),\n    db: AsyncIOMotorDatabase = Depends(get_db)\n):\n    """Get group details"""\n    group = await groups_db.get_group_by_id(db=db, group_id=group_id)\n    if not group:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Group not found\"\n        )\n    \n    # Get members\n    members_data = await groups_db.get_group_members(db=db, group_id=group_id)\n    members = [GroupMemberResponse(**m) for m in members_data]\n    \n    # Check if current user is a member\n    is_member = await groups_db.is_member(\n        db=db,\n        group_id=group_id,\n        user_id=current_user["id"]\n    )\n    \n    # Get user's role\n    user_role = None\n    if is_member:\n        user_role = await groups_db.get_member_role(\n            db=db,\n            group_id=group_id,\n            user_id=current_user["id"]\n        )\n    \n    return GroupDetailResponse(\n        **group,\n        members=members,\n        is_member=is_member,\n        user_role=user_role\n    )\n\n\n@router.put("/{group_id}", response_model=GroupResponse)\nasync def update_group(\n    group_id: str,\n    group_data: GroupUpdate,\n    current_user: dict = Depends(get_current_user),\n    db: AsyncIOMotorDatabase = Depends(get_db)\n):\n    """Update group information (owner/admin only)"""\n    # Check if user is owner or admin\n    role = await groups_db.get_member_role(\n        db=db,\n        group_id=group_id,\n        user_id=current_user["id"]\n    )\n    \n    if role not in ["owner", "admin"]:\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"Only group owners and admins can update group information\"\n        )\n    \n    # Update group\n    update_data = group_data.dict(exclude_unset=True)\n    success = await groups_db.update_group(db=db, group_id=group_id, update_data=update_data)\n    \n    if not success:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Group not found\"\n        )\n    \n    # Return updated group\n    group = await groups_db.get_group_by_id(db=db, group_id=group_id)\n    return GroupResponse(**group)\n\n\n@router.delete("/{group_id}", status_code=status.HTTP_204_NO_CONTENT)\nasync def delete_group(\n    group_id: str,\n    current_user: dict = Depends(get_current_user),\n    db: AsyncIOMotorDatabase = Depends(get_db)\n):\n    """Delete a group (owner only)"""\n    # Check if user is owner\n    role = await groups_db.get_member_role(\n        db=db,\n        group_id=group_id,\n        user_id=current_user["id"]\n    )\n    \n    if role != \"owner\":\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"Only group owners can delete groups\"\n        )\n    \n    success = await groups_db.delete_group(db=db, group_id=group_id)\n    if not success:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Group not found\"\n        )\n\n\n@router.post("/{group_id}/join", status_code=status.HTTP_200_OK)\nasync def join_group(\n    group_id: str,\n    current_user: dict = Depends(get_current_user),\n    db: AsyncIOMotorDatabase = Depends(get_db)\n):\n    """Join a group"""\n    # Check if group exists\n    group = await groups_db.get_group_by_id(db=db, group_id=group_id)\n    if not group:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Group not found\"\n        )\n    \n    # Check if already a member\n    is_member = await groups_db.is_member(\n        db=db,\n        group_id=group_id,\n        user_id=current_user["id"]\n    )\n    \n    if is_member:\n        raise HTTPException(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=\"Already a member of this group\"\n        )\n    \n    # Add member\n    await groups_db.add_member(\n        db=db,\n        group_id=group_id,\n        user_id=current_user["id"],\n        user_name=f\"{current_user['first_name']} {current_user['last_name']}\",\n        role=\"member\"\n    )\n    \n    return {\"message\": \"Successfully joined group\"}\n\n\n@router.post("/{group_id}/leave", status_code=status.HTTP_200_OK)\nasync def leave_group(\n    group_id: str,\n    current_user: dict = Depends(get_current_user),\n    db: AsyncIOMotorDatabase = Depends(get_db)\n):\n    """Leave a group"""\n    # Check if user is owner\n    role = await groups_db.get_member_role(\n        db=db,\n        group_id=group_id,\n        user_id=current_user["id"]\n    )\n    \n    if role == \"owner\":\n        raise HTTPException(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=\"Group owners cannot leave. Transfer ownership or delete the group.\"\n        )\n    \n    success = await groups_db.remove_member(\n        db=db,\n        group_id=group_id,\n        user_id=current_user["id"]\n    )\n    \n    if not success:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Not a member of this group\"\n        )\n    \n    return {\"message\": \"Successfully left group\"}\n\n\n@router.get("/{group_id}/members", response_model=List[GroupMemberResponse])\nasync def get_group_members(\n    group_id: str,\n    current_user: dict = Depends(get_current_user),\n    db: AsyncIOMotorDatabase = Depends(get_db)\n):\n    """Get all members of a group"""\n    members = await groups_db.get_group_members(db=db, group_id=group_id)\n    return [GroupMemberResponse(**m) for m in members]\n\n\n@router.patch("/{group_id}/members/{user_id}/role", status_code=status.HTTP_200_OK)\nasync def update_member_role(\n    group_id: str,\n    user_id: str,\n    role_data: UpdateMemberRoleRequest,\n    current_user: dict = Depends(get_current_user),\n    db: AsyncIOMotorDatabase = Depends(get_db)\n):\n    """Update a member's role (owner/admin only)"""\n    # Check if current user is owner or admin\n    current_role = await groups_db.get_member_role(\n        db=db,\n        group_id=group_id,\n        user_id=current_user["id"]\n    )\n    \n    if current_role not in ["owner", "admin"]:\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"Only owners and admins can update member roles\"\n        )\n    \n    # Can't change owner role\n    target_role = await groups_db.get_member_role(\n        db=db,\n        group_id=group_id,\n        user_id=user_id\n    )\n    \n    if target_role == \"owner\":\n        raise HTTPException(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=\"Cannot change owner role\"\n        )\n    \n    success = await groups_db.update_member_role(\n        db=db,\n        group_id=group_id,\n        user_id=user_id,\n        new_role=role_data.role\n    )\n    \n    if not success:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Member not found\"\n        )\n    \n    return {\"message\": f\"Member role updated to {role_data.role}\"}\n