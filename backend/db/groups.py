"""
BANIBS Backend - Groups Database Operations
Phase 8.5 - Groups & Membership
"""\n\nfrom motor.motor_asyncio import AsyncIOMotorDatabase\nfrom datetime import datetime, timezone\nfrom typing import List, Optional, Dict\nfrom uuid import uuid4\n\n\nasync def create_group(\n    db: AsyncIOMotorDatabase,\n    name: str,\n    description: Optional[str],\n    category: str,\n    is_private: bool,\n    tags: List[str],\n    creator_id: str,\n    creator_name: str\n) -> Dict:\n    """Create a new group"""\n    group_id = str(uuid4())\n    now = datetime.now(timezone.utc)\n    \n    group = {\n        "id": group_id,\n        "name": name,\n        "description": description,\n        "category": category,\n        "is_private": is_private,\n        "tags": tags,\n        "creator_id": creator_id,\n        "creator_name": creator_name,\n        "member_count": 1,\n        "created_at": now,\n        "updated_at": now\n    }\n    \n    await db.groups.insert_one(group)\n    \n    # Add creator as owner member\n    member = {\n        "id": str(uuid4()),\n        "group_id": group_id,\n        "user_id": creator_id,\n        "user_name": creator_name,\n        "role": "owner",\n        "joined_at": now\n    }\n    await db.group_members.insert_one(member)\n    \n    return group\n\n\nasync def get_group_by_id(db: AsyncIOMotorDatabase, group_id: str) -> Optional[Dict]:\n    """Get group by ID"""\n    return await db.groups.find_one({"id": group_id}, {"_id": 0})\n\n\nasync def get_groups(\n    db: AsyncIOMotorDatabase,\n    category: Optional[str] = None,\n    search: Optional[str] = None,\n    limit: int = 20,\n    offset: int = 0\n) -> List[Dict]:\n    """Get all groups with optional filters"""\n    query = {}\n    \n    if category:\n        query["category"] = category\n    \n    if search:\n        query["$or"] = [\n            {"name": {"$regex": search, "$options": "i"}},\n            {"description": {"$regex": search, "$options": "i"}},\n            {"tags": {"$in": [search]}}\n        ]\n    \n    cursor = db.groups.find(query, {"_id": 0})\n    cursor = cursor.sort("created_at", -1).skip(offset).limit(limit)\n    return await cursor.to_list(length=limit)\n\n\nasync def update_group(\n    db: AsyncIOMotorDatabase,\n    group_id: str,\n    update_data: Dict\n) -> bool:\n    """Update group information"""\n    update_data["updated_at"] = datetime.now(timezone.utc)\n    \n    result = await db.groups.update_one(\n        {"id": group_id},\n        {"$set": update_data}\n    )\n    return result.modified_count > 0\n\n\nasync def delete_group(db: AsyncIOMotorDatabase, group_id: str) -> bool:\n    """Delete a group and all its members"""\n    # Delete group\n    result = await db.groups.delete_one({"id": group_id})\n    \n    # Delete all members\n    await db.group_members.delete_many({"group_id": group_id})\n    \n    return result.deleted_count > 0\n\n\nasync def add_member(\n    db: AsyncIOMotorDatabase,\n    group_id: str,\n    user_id: str,\n    user_name: str,\n    role: str = "member"\n) -> Dict:\n    """Add a member to a group"""\n    member = {\n        "id": str(uuid4()),\n        "group_id": group_id,\n        "user_id": user_id,\n        "user_name": user_name,\n        "role": role,\n        "joined_at": datetime.now(timezone.utc)\n    }\n    \n    await db.group_members.insert_one(member)\n    \n    # Increment member count\n    await db.groups.update_one(\n        {"id": group_id},\n        {"$inc": {"member_count": 1}}\n    )\n    \n    return member\n\n\nasync def remove_member(\n    db: AsyncIOMotorDatabase,\n    group_id: str,\n    user_id: str\n) -> bool:\n    """Remove a member from a group"""\n    result = await db.group_members.delete_one({\n        "group_id": group_id,\n        "user_id": user_id\n    })\n    \n    if result.deleted_count > 0:\n        # Decrement member count\n        await db.groups.update_one(\n            {"id": group_id},\n            {"$inc": {"member_count": -1}}\n        )\n        return True\n    return False\n\n\nasync def get_group_members(\n    db: AsyncIOMotorDatabase,\n    group_id: str\n) -> List[Dict]:\n    """Get all members of a group"""\n    cursor = db.group_members.find({"group_id": group_id}, {"_id": 0})\n    return await cursor.to_list(length=None)\n\n\nasync def get_user_groups(\n    db: AsyncIOMotorDatabase,\n    user_id: str\n) -> List[Dict]:\n    """Get all groups a user is a member of"""\n    # Get group IDs\n    cursor = db.group_members.find({"user_id": user_id}, {"group_id": 1, "_id": 0})\n    memberships = await cursor.to_list(length=None)\n    group_ids = [m["group_id"] for m in memberships]\n    \n    if not group_ids:\n        return []\n    \n    # Get groups\n    cursor = db.groups.find({"id": {"$in": group_ids}}, {"_id": 0})\n    return await cursor.to_list(length=None)\n\n\nasync def is_member(\n    db: AsyncIOMotorDatabase,\n    group_id: str,\n    user_id: str\n) -> bool:\n    """Check if user is a member of a group"""\n    count = await db.group_members.count_documents({\n        "group_id": group_id,\n        "user_id": user_id\n    })\n    return count > 0\n\n\nasync def get_member_role(\n    db: AsyncIOMotorDatabase,\n    group_id: str,\n    user_id: str\n) -> Optional[str]:\n    """Get user's role in a group"""\n    member = await db.group_members.find_one({\n        "group_id": group_id,\n        "user_id": user_id\n    }, {"role": 1, "_id": 0})\n    \n    return member["role"] if member else None\n\n\nasync def update_member_role(\n    db: AsyncIOMotorDatabase,\n    group_id: str,\n    user_id: str,\n    new_role: str\n) -> bool:\n    """Update a member's role"""\n    result = await db.group_members.update_one(\n        {"group_id": group_id, "user_id": user_id},\n        {"$set": {"role": new_role}}\n    )\n    return result.modified_count > 0\n